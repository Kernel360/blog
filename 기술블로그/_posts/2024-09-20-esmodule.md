---
layout: post  
title: "ES Modules과 CommonJS"
author: "김승태"
categories: "프론트엔드 기술블로그"
banner:
  image: 썸네일로 넣고 싶은 이미지 링크
  background: "#000"
  height: "100vh"
  min_height: "38vh"
  heading_style: "font-size: 4.25em; font-weight: bold; text-decoration: underline"
  tags: [`module`]
---

# Module은 무엇인가요?

모듈은 코드의 집합입니다.

코드의 대부분은 변수를 변경하는 것이므로 이러한 변수를 어떻게 구성하느냐에 따라 코드 유지 관리에 큰 영향을 미칩니다. 모듈을 사용함으로써 각각 격리된 환경을 제공하고(충돌 방지), 재사용성과 유지 보수성을 높입니다.

JS에는 대표적으로 ES Modules, CommonJS 모듈 시스템이 있습니다.

# CommonJS 란?

CommonJS 모듈은 Node.js용 JavaScript 코드를 패키징하는 방식입니다. 모듈은 `require`와 `module.exports`를 사용하여 정의됩니다.

# ES Modules 이란?

ECMAScript modules은 재사용을 위해 자바스크립트 코드를 패키징하는 공식 표준 형식입니다. 모듈은 `import` 및 `export` 문을 사용하여 정의됩니다.

# CommonJS과 ES Modules은 무엇이 다른가요?

## 1. `require`는 동기적이고 `import`는 비동기적입니다.

require는 해당 모듈을 호출시에 동기적으로 불러오고 즉시 실행합니다.

왜 이렇게 동작할까요?

nodejs는 JS를 브라우저 바깥에서 실행하는 런타임 환경이고, 여러 모듈이 저장된 파일을 로드하는 것은 인터넷을 통해 다운로드하는 것보다 훨씬 적은 시간이 걸리기 때문에 메인 스레드를 차단해도 됩니다.

문제는 브라우저에서 require를 할 때입니다.

브라우저를 사용하는 환경의 성능은 알 수 없으며, 메인 스레드가 각 파일이 다운로드될 때까지 기다린다면 대기열에 다른 많은 작업이 쌓이게 됩니다. 브라우저에서 작업할 때는 다운로드하는 데 시간이 오래 걸리기 때문입니다.

이것이 ES Modules이 알고리즘을 여러 단계로 분할하는 이유 중 하나입니다. ES Module은 3단계로 나눠집니다.
![alt text](https://raw.githubusercontent.com/Kernel360/blog-image/main/2024/0920/3.png)
출처: https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/

1. Construction

   모든 파일을 찾아서 다운로드하고 모듈 레코드로 구문 분석합니다. `import` 및 `export`는 구문 분석 중에 결정될 수 있으며 실행 중에 변경되지 않습니다.

2. Instantiation

   모든 export된 값들을 메모리 내에 저장할 공간(박스)을 찾는 과정입니다. 하지만 이 시점에서는 값들을 채워 넣지 않습니다. 그런 다음, export와 import가 이 메모리 공간을 가리키도록 만듭니다. 이 과정을 Linking이라고 합니다.

3. Evaluation

   코드를 실행하여 변수의 실제 값으로 상자를 채웁니다. JS 엔진은 최상위 코드를 실행하여 이 작업을 수행합니다.

## 2. ES Modules는 Top-level `await`을 지원합니다.

```js
// ESM

// a.mjs
export const five = await Promise.resolve(5);

// b.mjs
import { five } from "./a.mjs";

console.log(five); // Logs `5`
```

## 3. Output copy vs Output reference

CommonJS에서는 값을 copy하고 ESM에서는 값을 참조합니다.

```js
// CommonJS

// 파일: a.js
let value = 1;
function increment() {
  value += 1;
}
module.exports = { value, increment };

// 파일: b.js
const a = require("./a");
console.log(a.value); // 1
a.increment();
console.log(a.value); // 1
// (원본 모듈의 변경 사항이 반영되지 않음)
```

```js
// 파일: a.mjs
export let value = 1;
export function increment() {
  value += 1;
}

// 파일: b.mjs
import { value, increment } from "./a.mjs";
console.log(value); // 1
increment();
console.log(value); // 2
// (원본 모듈의 변경 사항이 반영됨)
```

## 4. Import read-only feature of esm

CommonJS에서는 값을 복사하기에 수정도 가능합니다. 하지만 ES Modules은 값을 참조하기에 변경할 수 없습니다.

```js
// CommonJS

// a.js
let count = 0;
function increment() {
  count++;
  return count;
}
module.exports = { increment };

// b.js
const a = require("./a");
console.log(a.increment()); // 1
a.increment = function () {
  // 실행 중에 모듈의 함수를 변경
  return "Modified!";
};
console.log(a.increment()); // "Modified!"

// c.js
const a = require("./a");
console.log(a.increment()); // "Modified!"
```

```js
// ESM

// a.mjs
let count = 0;
export function increment() {
  count++;
  return count;
}

// b.mjs
import { increment } from "./a.mjs";
console.log(increment()); // 1

// b.mjs에서 increment 함수를 변경하려고 시도
// 이 시도는 실행 시 오류가 발생하지 않지만, 기존의 increment 함수는 여전히 원본의 함수입니다.
export const modifiedIncrement = function () {
  return "Modified!";
};

console.log(modifiedIncrement()); // "Modified!"

// c.mjs
import { increment } from "./a.mjs";
console.log(increment()); // 여전히 2가 출력됩니다.
```

---

이 외에도 CommonJS는 동적인 `require`, `module.export`가 가능하던가하는 등의 차이도 존재합니다.

```js
const randomNumber = Math.random();
const module = require(`./module/${randomNumber}`);

if (randomNumber % 2 === 0) {
  const utile = require(`./utile/${randomNumber}`);
}
```

# 참고 링크

[CommonJS와 ES Modules는 왜 함께할 수 없을까?](https://yceffort.kr/2020/08/commonjs-esmodules)

[commonjs란 무엇인가?](https://yceffort.kr/2023/05/what-is-commonjs)

[왜 esmodule 이어야 하는가?](https://yceffort.kr/2023/05/why-esmodule)

[CommonJS와 ESM에 모두 대응하는 라이브러리 개발하기: exports field](https://toss.tech/article/commonjs-esm-exports-field)

[CommonJS에서 ESM으로 전환하기](https://tech.kakao.com/posts/605)

[ES modules: A cartoon deep-dive](https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/)

https://nodejs.org/api/esm.html#resolution-and-loading-algorithm

https://nodejs.org/api/modules.html

https://f-lab.kr/insight/understanding-modern-javascript-module-system

[The difference between commonjs and esm](https://www.programmersought.com/article/29321724674/)

[ES6 In Depth: Modules](https://hacks.mozilla.org/2015/08/es6-in-depth-modules/)

[Previewing ES6 Modules and more from ES2015, ES2016 and beyond](https://blogs.windows.com/msedgedev/2016/05/17/es6-modules-and-beyond/)

[Axel Rauschmayer's book: "Exploring JS: Modules"](https://exploringjs.com/es6/ch_modules.html#sec_modules-in-javascript)

[Tree Shaking](https://webpack.kr/guides/tree-shaking/)
