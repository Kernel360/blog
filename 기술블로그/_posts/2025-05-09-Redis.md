---
layout: post  
title: "JWT ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ Redis í™œìš©í•˜ê¸°"
author: "ì•ˆí˜„ì§„"
categories: "ê¸°ìˆ ë¸”ë¡œê·¸"
banner:
  image:
  background: "#000"
  height: "100vh"
  min_height: "38vh"
  heading_style: "font-size: 4.25em; font-weight: bold; text-decoration: underline"
  tags: [`Redis`]
---

# [Redis #2] JWT ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ Redis í™œìš©í•˜ê¸°
**Refresh Token ë³´ì•ˆ êµ¬ì¡° ì„¤ê³„ì™€ êµ¬í˜„**  

---

## 1. ë“¤ì–´ê°€ë©°

JWT ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ Refresh Token ê´€ë¦¬ëŠ” **ë³´ì•ˆì„±ê³¼ ì‚¬ìš©ì ê²½í—˜ì˜ í•µì‹¬ ìš”ì†Œ**ì…ë‹ˆë‹¤.  
íŠ¹íˆ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì´ë‚˜ ì„œë²„ ì¸¡ í† í° ì œì–´ê°€ í•„ìš”í•œ ê²½ìš°, **í† í° ì €ì¥ì†Œ**ì˜ ë„ì…ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

> Redisë¥¼ í™œìš©í•œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹ Refresh Token ê´€ë¦¬ êµ¬ì¡°ì™€ Spring Bootë¡œì˜ ì‹¤ì œ êµ¬í˜„ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## 2. ì™œ ì„œë²„ê°€ í† í°ì„ ì €ì¥í•´ì•¼ í• ê¹Œ?

JWTëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Statelessí•˜ë©°, ì„œë²„ëŠ” í† í° ê²€ì¦ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.  
í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ìš”êµ¬ì‚¬í•­ì´ ìˆë‹¤ë©´ ì„œë²„ê°€ í† í°ì„ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤:

- ê°•ì œ ë¡œê·¸ì•„ì›ƒ, ê³„ì • ì •ì§€, í† í° ì¬ì‚¬ìš© ë°©ì§€
- 1ì¸ 1í† í° ì •ì±… (ì¤‘ë³µ ë¡œê·¸ì¸ ë°©ì§€)
- ë¡œê·¸ì•„ì›ƒ í›„ í† í° ë¬´íš¨í™”
- Rotation ê¸°ë°˜ ë³´ì•ˆ ê°•í™”

**â†’ Refresh Token ì €ì¥ì†Œê°€ í•„ìš”í•˜ê³  Redisê°€ ì í•©**

---

## 3. ì™œ Redisì¸ê°€? ë‹¤ë¥¸ ëŒ€ì•ˆë“¤ê³¼ ë¹„êµ

### Redisì˜ ì¥ì 

- ë©”ëª¨ë¦¬ ê¸°ë°˜ â†’ ë¹ ë¥¸ ì„±ëŠ¥
- TTL ì§€ì› â†’ ìë™ ë§Œë£Œ ì²˜ë¦¬
- ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ê°€ëŠ¥
- í‚¤ ê²€ìƒ‰(SCAN), ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

### ë¹„êµ í‘œ

| í•­ëª©         | Redis     | DB ì €ì¥ (RDB) | JVM Memory (Map ë“±) |
|--------------|-----------|---------------|----------------------|
| ì ‘ê·¼ ì†ë„    | ë§¤ìš° ë¹ ë¦„ | ëŠë¦¼          | ë§¤ìš° ë¹ ë¦„            |
| ê³µìœ  ê°€ëŠ¥ì„±  | O         | O             | X                    |
| TTL ì§€ì›     | O         | ì¼ë¶€ ê°€ëŠ¥     | X                    |
| ìœ ì—°ì„±       | ë†’ìŒ      | ë†’ìŒ          | ë‚®ìŒ                 |

---

## 4. í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹ vs ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°©ì‹

| í•­ëª©             | í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹                 | ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°©ì‹               |
|------------------|-----------------------------------|-------------------------------|
| ê¸°ë³¸ ê°œë…        | ìœ íš¨í•œ í† í°ë§Œ ì €ì¥                | ë¬´íš¨í™”ëœ í† í°ë§Œ ì €ì¥          |
| ì €ì¥ì†Œ ë¶€í•˜      | ì ìŒ (ìµœì‹  í† í°ë§Œ ì €ì¥)           | ë§ìŒ (ëª¨ë“  ë§Œë£Œ í† í° ì €ì¥)    |
| ì¬ì‚¬ìš© ê³µê²© ëŒ€ì‘ | Rotation + ë®ì–´ì“°ê¸°ë¡œ íƒì§€ ê°€ëŠ¥  | ë¸”ë™ë¦¬ìŠ¤íŠ¸ í™•ì¸ í•„ìš”           |
| ì í•©í•œ ìƒí™©      | Refresh ë³´ì•ˆ, Rotation í•„ìˆ˜ í™˜ê²½  | Access ë¬´íš¨í™” í•„ìš” ì‹œ          |

**ğŸ‘‰ ë³¸ ì‹œìŠ¤í…œì€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + Rotation ë°©ì‹ ì‚¬ìš©**

---

## 5. Refresh Token Redis ê´€ë¦¬ êµ¬ì¡° ì„¤ê³„

### ì €ì¥ êµ¬ì¡°

- Key: `refresh:user:{email}`
- Value: JWT Refresh Token
- TTL: 3ì¼ (72ì‹œê°„)

### ì „ì²´ íë¦„

1. ë¡œê·¸ì¸ â†’ access + refresh ë°œê¸‰
2. refreshëŠ” Redisì— ì €ì¥ (ê¸°ì¡´ ë®ì–´ì“°ê¸°)
3. access ë§Œë£Œ â†’ `/reissue` ìš”ì²­
4. Redisì—ì„œ refresh ì¡°íšŒ â†’ ì¼ì¹˜ í™•ì¸
5. ë¯¸ì¼ì¹˜ ì‹œ ì¬ì‚¬ìš© ê³µê²© ê°„ì£¼
6. ë¡œê·¸ì•„ì›ƒ ì‹œ Redis í† í° ì‚­ì œ

---

## 6. ì‹¤ì œ êµ¬í˜„ (Spring Boot)

### âœ… Refresh Token ì €ì¥

```java
public void saveRefreshToken(String email, String token) {
    redisTemplate.opsForValue().set("refresh:user:" + email, token, 3, TimeUnit.DAYS);
}
```

---

### âœ… Refresh Token ìœ íš¨ì„± ê²€ì¦

```java
public void validateRefreshToken(String token) {
    if (jwtUtil.isExpired(token)) {
        throw new TokenValidationException("Token expired");
    }

    if (!"refresh".equals(jwtUtil.getCategory(token))) {
        throw new TokenValidationException("Invalid token type");
    }

    String email = jwtUtil.getEmail(token);
    String saved = redisTemplate.opsForValue().get("refresh:user:" + email);
    if (!token.equals(saved)) {
        throw new TokenValidationException("Token not in whitelist");
    }
}
```

---

### âœ… ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬

```java
public void removeRefreshToken(String token) {
    String email = jwtUtil.getEmail(token);
    redisTemplate.delete("refresh:user:" + email);
}
```

---

### âœ… ì‘ë‹µì— í† í° ë‹´ê¸°

```java
public static void addTokensToResponse(HttpServletResponse response, TokenPair tokens) {
    response.setHeader("Authorization", "Bearer " + tokens.getAccessToken());
    response.addCookie(CookieUtil.createRefreshTokenCookie(tokens.getRefreshToken()));
}
```

---

## 7. ë¦¬íŒ©í† ë§ ë°©í–¥ ë° ê³ ë ¤ì‚¬í•­

### 1ï¸âƒ£ ì—­í•  ë¶„ë¦¬

- `TokenService` â†’ í† í° ìƒì„±/ê²€ì¦/ì €ì¥
- `JWTUtil` â†’ JWT ìƒì„± ë° íŒŒì‹±
- `CookieUtil`, `TokenResponseUtil` â†’ ì¿ í‚¤ ìƒì„± ë° ì‘ë‹µ êµ¬ì„±

---

### 2ï¸âƒ£ ì˜ˆì™¸ ì²˜ë¦¬ í†µì¼

- `TokenValidationException` â†’ ëª¨ë“  ì¸ì¦ ì‹¤íŒ¨ ì²˜ë¦¬
- `@ControllerAdvice` â†’ ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬

---

### 3ï¸âƒ£ ì„¤ì • ì™¸ë¶€í™”

- TTL, Redis Key Prefix ë“±ì€ `application.yml`ë¡œ ê´€ë¦¬

---

### 4ï¸âƒ£ í…ŒìŠ¤íŠ¸ ì „ëµ

- Redis ì—†ëŠ” í™˜ê²½ì—ì„  Mock ë˜ëŠ” `embedded-redis` ì‚¬ìš©

---

## 8. ë§ˆë¬´ë¦¬

RedisëŠ” Refresh Tokenì„ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê³ , ë³´ì•ˆì ìœ¼ë¡œ ê²€ì¦í•  ìˆ˜ ìˆëŠ” ì´ìƒì ì¸ ì €ì¥ì†Œì…ë‹ˆë‹¤.  
í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + Rotation ê¸°ë°˜ ì„¤ê³„ë¥¼ í†µí•´ ë‹¤ìŒì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- ì¬ì‚¬ìš© ê³µê²© ë°©ì§€
- ì„œë²„ ì£¼ë„ ë³´ì•ˆ ì œì–´
- Stateless ì•„í‚¤í…ì²˜ ìœ ì§€
